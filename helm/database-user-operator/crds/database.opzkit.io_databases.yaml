---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
  name: databases.database.opzkit.io
spec:
  group: database.opzkit.io
  names:
    kind: Database
    listKind: DatabaseList
    plural: databases
    shortNames:
    - db
    singular: database
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.engine
      name: Engine
      type: string
    - jsonPath: .spec.databaseName
      name: Database
      type: string
    - jsonPath: .status.actualUsername
      name: Username
      type: string
    - jsonPath: .status.actualSecretName
      name: SecretName
      type: string
    - jsonPath: .status.secretRegion
      name: Region
      type: string
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Database is the Schema for the databases API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: DatabaseSpec defines the desired state of Database
            properties:
              awsSecretsManager:
                description: |-
                  AWSSecretsManager contains AWS Secrets Manager specific configuration for storing created credentials
                  All created credentials are stored in AWS Secrets Manager regardless of connection string source
                properties:
                  description:
                    description: Description is the description for the AWS Secrets
                      Manager secret
                    type: string
                  region:
                    description: Region is the AWS region for Secrets Manager
                    enum:
                    - us-east-1
                    - us-east-2
                    - us-west-1
                    - us-west-2
                    - us-gov-west-1
                    - us-gov-east-1
                    - af-south-1
                    - ap-east-1
                    - ap-south-1
                    - ap-south-2
                    - ap-northeast-1
                    - ap-northeast-2
                    - ap-northeast-3
                    - ap-southeast-1
                    - ap-southeast-2
                    - ap-southeast-3
                    - ap-southeast-4
                    - ca-central-1
                    - ca-west-1
                    - eu-central-1
                    - eu-central-2
                    - eu-west-1
                    - eu-west-2
                    - eu-west-3
                    - eu-south-1
                    - eu-south-2
                    - eu-north-1
                    - me-south-1
                    - me-central-1
                    - sa-east-1
                    - cn-north-1
                    - cn-northwest-1
                    - il-central-1
                    type: string
                  tags:
                    additionalProperties:
                      type: string
                    description: Tags are tags to apply to the AWS Secrets Manager
                      secret
                    type: object
                required:
                - region
                type: object
              connectionStringAWSSecretRef:
                description: |-
                  ConnectionStringAWSSecretRef references an AWS Secrets Manager secret containing the admin connection string
                  Either ConnectionStringSecretRef or ConnectionStringAWSSecretRef must be specified.
                  Note: Created database credentials will always be stored in AWS Secrets Manager.
                properties:
                  key:
                    description: |-
                      Key within the secret JSON
                      Defaults to "connectionString"
                    type: string
                  region:
                    description: Region is the AWS region for Secrets Manager
                    enum:
                    - us-east-1
                    - us-east-2
                    - us-west-1
                    - us-west-2
                    - us-gov-west-1
                    - us-gov-east-1
                    - af-south-1
                    - ap-east-1
                    - ap-south-1
                    - ap-south-2
                    - ap-northeast-1
                    - ap-northeast-2
                    - ap-northeast-3
                    - ap-southeast-1
                    - ap-southeast-2
                    - ap-southeast-3
                    - ap-southeast-4
                    - ca-central-1
                    - ca-west-1
                    - eu-central-1
                    - eu-central-2
                    - eu-west-1
                    - eu-west-2
                    - eu-west-3
                    - eu-south-1
                    - eu-south-2
                    - eu-north-1
                    - me-south-1
                    - me-central-1
                    - sa-east-1
                    - cn-north-1
                    - cn-northwest-1
                    - il-central-1
                    type: string
                  secretName:
                    description: SecretName is the name or ARN of the AWS Secrets
                      Manager secret
                    type: string
                required:
                - region
                - secretName
                type: object
              connectionStringSecretRef:
                description: |-
                  ConnectionStringSecretRef references a Kubernetes Secret containing the admin connection string
                  to the existing database instance. Must have proper permissions to create databases and users.
                  Either ConnectionStringSecretRef or ConnectionStringAWSSecretRef must be specified.
                  Note: Created database credentials will always be stored in AWS Secrets Manager.
                properties:
                  key:
                    description: |-
                      Key within the secret
                      Defaults to "connectionString"
                    type: string
                  name:
                    description: Name of the secret
                    type: string
                required:
                - name
                type: object
              databaseName:
                description: DatabaseName is the name of the database to create
                maxLength: 63
                minLength: 1
                pattern: ^[a-z][a-z0-9_]*$
                type: string
              engine:
                default: postgres
                description: Engine specifies the database engine type
                enum:
                - postgres
                - postgresql
                - mysql
                - mariadb
                type: string
              privileges:
                description: |-
                  Privileges defines what privileges to grant to the user
                  Defaults to ALL PRIVILEGES on the created database
                items:
                  type: string
                type: array
              retainOnDelete:
                default: true
                description: |-
                  RetainOnDelete determines whether to retain the database and user when the CR is deleted
                  Defaults to true (retains resources on deletion)
                type: boolean
              secretName:
                description: |-
                  SecretName is the name/path for storing the created credentials in AWS Secrets Manager
                  Defaults to rds/<engine>/<databaseName>
                type: string
              secretTemplate:
                description: |-
                  SecretTemplate is a Go template for customizing the secret structure
                  Available variables: .DBHost, .DBPort, .DBName, .DBUsername, .DBPassword, .DatabaseURL, .Engine
                  If not specified, uses the default template with DB_HOST, DB_PORT, DB_NAME, DB_USERNAME, DB_PASSWORD, and <ENGINE>_URL
                  The template must produce valid JSON
                type: string
              username:
                description: |-
                  Username for the database user to be created
                  Defaults to the DatabaseName if not specified
                maxLength: 63
                pattern: ^[a-z][a-z0-9_]*$
                type: string
            required:
            - databaseName
            - engine
            type: object
          status:
            description: DatabaseStatus defines the observed state of Database
            properties:
              actualSecretName:
                description: ActualSecretName is the actual secret name that was created
                type: string
              actualUsername:
                description: ActualUsername is the actual username that was created
                type: string
              conditions:
                description: Conditions represent the latest available observations
                  of the Database's state
                items:
                  description: "Condition contains details for one aspect of the current
                    state of this API Resource.\n---\nThis struct is intended for
                    direct use as an array at the field path .status.conditions.  For
                    example,\n\n\n\ttype FooStatus struct{\n\t    // Represents the
                    observations of a foo's current state.\n\t    // Known .status.conditions.type
                    are: \"Available\", \"Progressing\", and \"Degraded\"\n\t    //
                    +patchMergeKey=type\n\t    // +patchStrategy=merge\n\t    // +listType=map\n\t
                    \   // +listMapKey=type\n\t    Conditions []metav1.Condition `json:\"conditions,omitempty\"
                    patchStrategy:\"merge\" patchMergeKey:\"type\" protobuf:\"bytes,1,rep,name=conditions\"`\n\n\n\t
                    \   // other fields\n\t}"
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: |-
                        type of condition in CamelCase or in foo.example.com/CamelCase.
                        ---
                        Many .condition.type values are consistent across resources like Available, but because arbitrary conditions can be
                        useful (see .node.status.conditions), the ability to deconflict is important.
                        The regex it matches is (dns1123SubdomainFmt/)?(qualifiedNameFmt)
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              connectionInfo:
                description: ConnectionInfo provides non-sensitive connection information
                properties:
                  database:
                    description: Database is the database name
                    type: string
                  engine:
                    description: Engine is the database engine
                    type: string
                  host:
                    description: Host is the database host
                    type: string
                  port:
                    description: Port is the database port
                    type: integer
                  username:
                    description: Username is the database username
                    type: string
                type: object
              databaseCreated:
                description: DatabaseCreated indicates whether the database has been
                  created
                type: boolean
              message:
                description: Message provides additional information about the current
                  state
                type: string
              observedGeneration:
                description: ObservedGeneration is the most recent generation observed
                  by the controller
                format: int64
                type: integer
              phase:
                description: |-
                  Phase represents the current phase of the Database
                  Possible values: Pending, Creating, Ready, Failed, Deleting
                type: string
              secretARN:
                description: SecretARN is the ARN of the created AWS Secrets Manager
                  secret (if applicable)
                type: string
              secretCreated:
                description: SecretCreated indicates whether the secret has been created
                type: boolean
              secretFormatVersion:
                description: SecretFormatVersion tracks the secret structure version
                  (v1=old format, v2=new format with DB_HOST, etc.)
                type: string
              secretRegion:
                description: SecretRegion is the AWS region where the secret is stored
                type: string
              secretVersion:
                description: SecretVersion is the version ID of the secret
                type: string
              userCreated:
                description: UserCreated indicates whether the user has been created
                type: boolean
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
